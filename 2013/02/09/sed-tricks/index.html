<!DOCTYPE html>
<!--[if lt IE 7 ]><html class="ie ie6" lang="en"> <![endif]-->
<!--[if IE 7 ]><html class="ie ie7" lang="en"> <![endif]-->
<!--[if IE 8 ]><html class="ie ie8" lang="en"> <![endif]-->
<!--[if (gte IE 9)|!(IE)]><!--><html lang="en"> <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Morten Kristensen - sed tricks</title>
  <meta name="author" content="Morten Kristensen" />
  <meta name="description" content="The blog of Morten Kristensen" />
  <link rel="canonical" href="http://nullpointer.dk/2013/02/09/sed-tricks/" />

  <link href="//fonts.googleapis.com/css?family=Open+Sans:600,800" rel="stylesheet" type="text/css">
  <link rel="shortcut icon" href="/favicon.png">
  <link rel="alternate" type="application/atom+xml" title="Morten Kristensen" href="http://nullpointer.dk/atom.xml" />

  <link rel="stylesheet" href="/assets/css/all.css">
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha256-k2/8zcNbxVIh5mnQ52A0r3a6jAgMGxFJFE2707UxGCk= sha512-ZV9KawG2Legkwp3nAlxLIVFudTauWuBpC10uEafMHYL0Sarrz5A7G79kXh5+5+woxQ5HM559XX2UZjMJ36Wplg==" crossorigin="anonymous">
</head>
<body>
  <div class="container">
    <div class="four columns sidebar">
      <nav>
  <h1>Hi.</h1>
  <a href="/">
    
    <img src="http://www.gravatar.com/avatar/77268e36fb81d8421b553f0bccceb69c?s=250" id="gravatar" alt="My photo"/>
    
  </a>
  <h2>I'm <a href="/">Morten Kristensen</a>.</h2>
  <div id="bio">
    <p>C++, Python, Emacs, Clang, CMake, and other technobabble..</p>
  </div>
  <div id="social">
    Follow me:
<div id="stalker">
  
  <a title="netromdk on Github" href="https://github.com/netromdk">
    <i class="fa fa-github-square"></i>
  </a>
  

  

  

  

  
  <a title="Morten Kristensen on Stack Overflow" href="http://stackoverflow.com/users/642148">
    <i class="fa fa-stack-overflow"></i>
  </a>
  

  
  <a title="netromdk on Twitter" href="https://twitter.com/netromdk">
    <i class="fa fa-twitter-square"></i>
  </a>
  

  

  

  
  <a title="Morten Kristensen on LinkedIn" href="https://www.linkedin.com/in/mortenslotkristensen">
    <i class="fa fa-linkedin-square"></i>
  </a>
  

  

  

  
  <a title="Atom feed" id="atom" href="/atom.xml">
    <i class="fa fa-rss-square"></i>
  </a>
  
</div>

  </div>
</nav>

    </div>

    <div class="eleven columns content">
      <p class="meta">
  February 09, 2013 
  <a href="/">
    <i class="home fa fa-home"></i>
  </a>
  <br/>
  Tags:
  
    <a href="/tag/sed" class="tag">sed</a>
  
    <a href="/tag/bsd" class="tag">bsd</a>
  
    <a href="/tag/gnu" class="tag">gnu</a>
  
</p>

<h1 class="title">sed tricks</h1>

<div id="post">
  <p>The <strong>s</strong>tream <strong>ed</strong>itor, most commonly know as <b>sed</b>, is a wonderful tool for modifying data from files and stdin. <em>In this article I will be using the BSD variant of sed which is a little bit different from the GNU variant of sed but I will try to point out where the differences are in my examples.</em></p>

<h4>Usage</h4>
<p>One of the most common ways of using sed is:</p>

<div class="language-shell highlighter-rouge"><pre class="highlight"><code>cat file.txt | sed COMMAND
</code></pre>
</div>

<p>And the other</p>

<div class="language-shell highlighter-rouge"><pre class="highlight"><code>sed COMMAND FILE
</code></pre>
</div>

<p>It is possible to have multiple commands using the <code class="highlighter-rouge">-e</code> argument:</p>

<div class="language-shell highlighter-rouge"><pre class="highlight"><code>sed -e COMMAND -e COMMAND ..
</code></pre>
</div>

<p>Or even like this:</p>

<div class="language-shell highlighter-rouge"><pre class="highlight"><code>sed <span class="s1">'COMMAND;COMMAND;..'</span>
</code></pre>
</div>

<p>The <em>COMMAND</em> can be a lot of different things but usually it will be the substitution pattern: <code class="highlighter-rouge">s/regular expression/replacement/flags</code></p>

<p>Here is an example:</p>

<div class="language-shell highlighter-rouge"><pre class="highlight"><code><span class="nb">echo</span> <span class="s2">"aabb"</span> | sed -e <span class="s1">'s/a/A/'</span> -e <span class="s1">'s/b/B/g'</span>
AaBB
</code></pre>
</div>

<p>Notice that the first command is only run on the first occurrence and the second is run on all using the <code class="highlighter-rouge">g</code> flag. Keep in mind that it works on a <em>line-by-line</em> basis.</p>

<p>Another important aspect is <em>in-place</em> alteration of files:</p>

<div class="language-shell highlighter-rouge"><pre class="highlight"><code>sed -i <span class="o">(</span>EXT<span class="o">)</span> COMMAND FILE
</code></pre>
</div>

<p>This command will edit FILE using COMMAND and if the extension EXT is given then a backup is saved to the FILE with EXT appended to the filename. It is generally recommended to produce backup files so nothing is lost unintentionally.</p>

<h4>Group matching</h4>
<p>Often it is necessary to match some block of data and substitute some portions without removing other parts, or to alter the order of blocks. A group is matched using parentheses in the command and referenced with <code class="highlighter-rouge">\\1</code>,<code class="highlighter-rouge">\\2</code>.. etc., for instance:</p>

<div class="language-shell highlighter-rouge"><pre class="highlight"><code><span class="nb">echo</span> <span class="s2">"foobar"</span> | sed <span class="s1">'s/\\(foo\\)\\(bar\\)/\\2\\1/'</span>
barfoo
</code></pre>
</div>
<p>Two groups are matched (“foo” and “bar”) and their order is reversed. Notice that the parentheses have to be escaped in order to prevent matching the actual characters “(“ and “)”.</p>

<h4>Extended regular expressions</h4>
<p>The expressions I have used up until now were basic regular expressions but a more powerful variant exists, namely the extended regular expressions. In this mode, along with a lot of stuff, it’s not necessary to escape parentheses and the POSIX character sets are available. Example:</p>

<div class="language-shell highlighter-rouge"><pre class="highlight"><code><span class="nb">echo</span> <span class="s2">"foo </span><span class="se">\\</span><span class="s2">t bar"</span> | sed -E <span class="s1">'s/(foo)[[:space:]]*(bar)/\\2 \\1/'</span>
bar foo
</code></pre>
</div>
<p>The character set <code class="highlighter-rouge">[:space:]</code> matches any whitespace character. <b><em><code class="highlighter-rouge">-E</code> is replaced with <code class="highlighter-rouge">-r</code> in GNU sed.</em></b></p>

<p><a href="http://www.grymoire.com/Unix/Regular.html" target="_blank">Here</a> is a great reference of the different regular expressions, both basic and extended ones.</p>

<h4>Case sensitivity</h4>
<p>In GNU sed there is a flag to turn off case sensitivity, namely the “i” flag. Sadly this flag is not available in BSD sed so one has to turn to other possibilities. One is to decapitalize all letters before piping to sed, but that doesn’t work for files and in-place modifications. However, case can be ignored when using character sets and similar constructs so keep that in mind, i.e. <code class="highlighter-rouge">[:alpha:]</code> will match “A” as well as “a”. Selective parts of a regular expression can sometimes require specific characters so if one wants to match both cases it can be done using ranges, like <code class="highlighter-rouge">[a-cA-C]</code> for instance.</p>

<p>Different approaches exist for decapitalizing using pipes. Here is one using <code class="highlighter-rouge">tr</code>:</p>

<div class="language-shell highlighter-rouge"><pre class="highlight"><code><span class="nb">echo</span> <span class="s2">"Hello, World"</span> | tr <span class="s1">'[:upper:]'</span> <span class="s1">'[:lower:]'</span>
hello, world
</code></pre>
</div>

<p>And here is one using <code class="highlighter-rouge">awk</code>:</p>

<div class="language-shell highlighter-rouge"><pre class="highlight"><code><span class="nb">echo</span> <span class="s2">"Hello, World"</span> | awk <span class="s1">'{print tolower($0)}'</span>
hello, world
</code></pre>
</div>

<p>If all else fails Perl has a sed-like substitution syntax  that accepts the “i” flag:</p>

<div class="language-shell highlighter-rouge"><pre class="highlight"><code><span class="nb">echo</span> <span class="s2">"HeLlo"</span> | perl -pe <span class="s1">'s/l/./ig'</span>
He..o
</code></pre>
</div>

<h4>Greedy vs non-greedy matching</h4>
<p>sed is greedy by default, meaning it will try to match as much as possible when using <code class="highlighter-rouge">+</code> or <code class="highlighter-rouge">*</code>. Here’s a greedy example:</p>

<div class="language-shell highlighter-rouge"><pre class="highlight"><code><span class="nb">echo</span> <span class="s2">"aaa(bbb)aaa(bbb)aaa"</span> | sed -E <span class="s1">'s/\\(.*\\)/./'</span>
aaa.aaa
</code></pre>
</div>
<p>The above matches a “(“ then anything greedily until next “)”. Suppose we wanted to only match the first “(bbb)” and not “(bbb)aaa(bbb)”, then we could do the following:</p>

<div class="language-shell highlighter-rouge"><pre class="highlight"><code><span class="nb">echo</span> <span class="s2">"aaa(bbb)aaa(bbb)aaa"</span> | sed -E <span class="s1">'s/\\([^\\(]*\\)/./'</span>
aaa.aaa<span class="o">(</span>bbb<span class="o">)</span>aaa
</code></pre>
</div>
<p>As before it matches a “(“ then matching non-greedily for “(“ (meaning <em>not</em> matching a “(“) until we match the closing “)”.</p>

<h4>Examples</h4>
<p>A friend of mine recently asked me how to replace entries of the form “&lt;email address&gt;” with “&lt;–removed–&gt;” using sed. The following was the solution:</p>

<div class="language-shell highlighter-rouge"><pre class="highlight"><code>cat file.txt | sed -E <span class="s1">'s/(&lt;).*@.*(&gt;)/\\1--removed--\\2/g'</span>
</code></pre>
</div>
<p>It’s not a correct regexp for matching email addresses but given the knowledge of the presence of &lt;, &gt; and @ it was fitting in his scenario.</p>

<p>The proper way of doing it would be the following:</p>

<div class="language-shell highlighter-rouge"><pre class="highlight"><code>cat file.txt | sed -E <span class="s1">'s/(&lt;)[[:alpha:][:digit:]\\._%\\+-]+@[[:alpha:][:digit:]\\.-]+\\.[[:alpha:]]{2,4}(&gt;)/\\1--removed--\\2/g'</span>
</code></pre>
</div>

<p>Another useful thing is to escape spaces in filenames and use them with commands:</p>

<div class="language-shell highlighter-rouge"><pre class="highlight"><code><span class="c">#!/bin/sh</span>
<span class="nv">DIR</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$1</span> | sed <span class="s1">'s/ /\\\\\\\\ /g'</span><span class="sb">`</span>
<span class="nb">eval echo</span> <span class="s2">"Listing </span><span class="k">${</span><span class="nv">DIR</span><span class="k">}</span><span class="s2">:"</span>
<span class="nb">eval </span>ls -l <span class="k">${</span><span class="nv">DIR</span><span class="k">}</span>
</code></pre>
</div>

<p>I used <em>double-escaped backslashes</em> because the final output should be, for instance, “/test\ one\ seven/foobar.txt” and not “/test one seven/foobar.txt” so that the commands can interpret the paths correctly (using the <code class="highlighter-rouge">eval</code> command). The effect is that the script can be called with both an escaped or non-escaped path, i.e. <code class="highlighter-rouge">"/test one seven"</code> or <code class="highlighter-rouge">/test\\ one\\ seven</code>.</p>

<p>When creating a Linux distribution of a program or similar that is required to run off-the-bat, and where the source code might not be available, it is often needed to get all the shared library dependencies of certain binary files. The following script will copy these to the destination directory: <b>(Linux only!)</b></p>

<div class="language-shell highlighter-rouge"><pre class="highlight"><code><span class="c">#!/bin/sh</span>
<span class="c"># Usage: getshared.sh &lt;binary&gt; &lt;dest directory&gt;</span>
<span class="nv">BIN</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$1</span> | sed <span class="s1">'s/ /\\\\\\\\ /g'</span><span class="sb">`</span>
<span class="nv">DST</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$2</span> | sed <span class="s1">'s/ /\\\\\\\\ /g'</span><span class="sb">`</span>
<span class="nb">eval </span>mkdir -p <span class="k">${</span><span class="nv">DST</span><span class="k">}</span>
<span class="nb">eval </span>ldd <span class="k">${</span><span class="nv">BIN</span><span class="k">}</span> | grep <span class="s2">"=&gt;"</span> | sed <span class="s1">'s/.*\\s*=&gt;\\s*\\(.*\\)(.*)/\\1/'</span> | awk <span class="s1">'{print $1};'</span> | <span class="nb">eval </span>xargs -I<span class="o">{}</span> cp -vuL <span class="o">{}</span> <span class="k">${</span><span class="nv">DST</span><span class="k">}</span>
</code></pre>
</div>

<p>Here the sed command retrieves the dependency library from the output using the <code class="highlighter-rouge">\\1</code> group. A sample line from <code class="highlighter-rouge">ldd</code> could be</p>

<div class="language-shell highlighter-rouge"><pre class="highlight"><code>libc.so.6 <span class="o">=</span>&gt; /usr/x86_64-linux-gnu/libc.so.6 <span class="o">(</span>0x00007f6eb8c000<span class="o">)</span>
</code></pre>
</div>

<p>Assume we have a file we want to modify in-place, like an INI configuration file like this:</p>

<div class="language-ini highlighter-rouge"><pre class="highlight"><code><span class="nn">[Section]</span>
<span class="py">enableStuff</span><span class="p">=</span><span class="s">false  </span>
<span class="py">someVar</span><span class="p">=</span><span class="s">1337</span>
<span class="py">enableOther</span> <span class="p">=</span> <span class="s">false</span>
<span class="py">dontTouchThis</span><span class="p">=</span><span class="s">"wicked"</span>
<span class="err">oldSchool:</span> <span class="err">false</span>
</code></pre>
</div>

<p>And let’s say we wanted to replace all instances of “false” with “true”:</p>

<div class="language-shell highlighter-rouge"><pre class="highlight"><code>sed -i .bck -E <span class="s1">'s/([[:alnum:]]+)[^\\s]*([=:])[^\\s]*false/\\1\\2true/'</span> conf.ini
</code></pre>
</div>

<p>You will get the following result in <code class="highlighter-rouge">conf.ini</code> (along with the backup in <code class="highlighter-rouge">conf.ini.bck</code>):</p>

<div class="language-ini highlighter-rouge"><pre class="highlight"><code><span class="nn">[Section]</span>
<span class="py">enableStuff</span><span class="p">=</span><span class="s">true  </span>
<span class="py">someVar</span><span class="p">=</span><span class="s">1337</span>
<span class="py">enableOther</span><span class="p">=</span><span class="s">true</span>
<span class="py">dontTouchThis</span><span class="p">=</span><span class="s">"wicked"</span>
<span class="err">oldSchool:true</span>
</code></pre>
</div>

<p>Notice that I remove all whitespace and that I allow both “=” and “:” as the delimiter because some implementations use “:” however uncommon it may be.</p>

<p>That concludes my tips and tricks using sed.</p>


</div>

<div id="related">
  <h3>Related Posts</h3>
  <ul class="posts">
    
    <li>
      <span>29 Aug 2016 &raquo;</span> <a href="/2016/08/29/rewamped-for-github/">Rewamped for GitHub</a>
    </li>
    
    <li>
      <span>06 Mar 2013 &raquo;</span> <a href="/2013/03/06/proper-multithreading-with-qt/">Proper multithreading with Qt</a>
    </li>
    
    <li>
      <span>03 Mar 2013 &raquo;</span> <a href="/2013/03/03/unleashing-the-power-of-gdb-part2/">Unleashing the Power of GDB (part 2)</a>
    </li>
    
  </ul>
</div>


      <div class="footer">
        <div class="disclaimer">
  

  <p>
    © Morten Kristensen, 2016
  </p>
</div>

      </div>
    </div>
  </div>


</body>
</html>
