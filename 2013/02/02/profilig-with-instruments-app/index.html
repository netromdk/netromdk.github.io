<!DOCTYPE html>
<!--[if lt IE 7 ]><html class="ie ie6" lang="en"> <![endif]-->
<!--[if IE 7 ]><html class="ie ie7" lang="en"> <![endif]-->
<!--[if IE 8 ]><html class="ie ie8" lang="en"> <![endif]-->
<!--[if (gte IE 9)|!(IE)]><!--><html lang="en"> <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Morten Kristensen - Profiling with Instruments.app</title>
  <meta name="author" content="Morten Kristensen" />
  <meta name="description" content="The blog of Morten Kristensen" />
  <link rel="canonical" href="http://nullpointer.dk/2013/02/02/profilig-with-instruments-app/" />

  <link href="//fonts.googleapis.com/css?family=Open+Sans:600,800" rel="stylesheet" type="text/css">
  <link rel="shortcut icon" href="/favicon.png">
  <link rel="alternate" type="application/atom+xml" title="Morten Kristensen" href="http://nullpointer.dk/atom.xml" />

  <link rel="stylesheet" href="/assets/css/all.css">
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha256-k2/8zcNbxVIh5mnQ52A0r3a6jAgMGxFJFE2707UxGCk= sha512-ZV9KawG2Legkwp3nAlxLIVFudTauWuBpC10uEafMHYL0Sarrz5A7G79kXh5+5+woxQ5HM559XX2UZjMJ36Wplg==" crossorigin="anonymous">
</head>
<body>
  <div class="container">
    <div class="four columns sidebar">
      <nav>
  <h1>Hi.</h1>
  <a href="/">
    
    <img src="http://www.gravatar.com/avatar/77268e36fb81d8421b553f0bccceb69c?s=250" id="gravatar" alt="My photo"/>
    
  </a>
  <h2>I'm <a href="/">Morten Kristensen</a>.</h2>
  <div id="bio">
    <p>C++, Python, Emacs, Clang, CMake, and other technobabble..</p>
  </div>
  <div id="social">
    Follow me:
<div id="stalker">
  
  <a title="netromdk on Github" href="https://github.com/netromdk">
    <i class="fa fa-github-square"></i>
  </a>
  

  

  

  

  
  <a title="Morten Kristensen on Stack Overflow" href="http://stackoverflow.com/users/642148">
    <i class="fa fa-stack-overflow"></i>
  </a>
  

  
  <a title="netromdk on Twitter" href="https://twitter.com/netromdk">
    <i class="fa fa-twitter-square"></i>
  </a>
  

  

  

  
  <a title="Morten Kristensen on LinkedIn" href="https://www.linkedin.com/in/mortenslotkristensen">
    <i class="fa fa-linkedin-square"></i>
  </a>
  

  

  

  
  <a title="Atom feed" id="atom" href="/atom.xml">
    <i class="fa fa-rss-square"></i>
  </a>
  
</div>

  </div>
</nav>

    </div>

    <div class="eleven columns content">
      <p class="meta">
  February 02, 2013 
  <a href="/">
    <i class="home fa fa-home"></i>
  </a>
  <br/>
  Tags:
  
    <a href="/tag/profiling" class="tag">profiling</a>
  
    <a href="/tag/c++" class="tag">c++</a>
  
</p>

<h1 class="title">Profiling with Instruments.app</h1>

<div id="post">
  <p>Profiling binaries is essential in any serious development process. Unfortunately not very many good profilers exist out there. I usually employ <a href="http://valgrind.org">Valgrind</a> to detect memory leaks and the front-end <a href="http://kcachegrind.sourceforge.net">KCachegrind</a> to inspect call stacks. But KCachegrind requires both X11 and KDE3 libs which I want to avoid. However, last week I discovered <span style="text-decoration: underline;">Instruments.app</span> that comes with Xcode. It’s a great profiler with lots of different modes, like detecting memory leaks, tracking heap allocations, detection of “zombie” objects, time-based profiling, performance monitor counter (PMC) based sampling, event-based sampling, file activity, sudden termination analysis and much more. <em>But Instruments.app is not good at finding uninitialized variables like Valgrind is among other things - so this is not a direct substitution!</em></p>

<p>The app is located here:</p>
<p><blockquote>/Applications/Xcode.app/Contents/Applications/Instruments.app</blockquote></p>

<p>Let’s write a little program with a memory leak that we want the program to detect for us.</p>

<p>Save the following code to a file named “memleak.cpp”:</p>

<div class="language-c++ highlighter-rouge"><pre class="highlight"><code><span class="cp">#include &lt;unistd.h&gt;
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">test</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">char</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>
    <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
</div>

<p>Compile the program and run Instruments.app. When it starts select the “Leaks” template in the “Mac OS X” section and click “Choose”. A new window opens up showing two instruments; one for allocations and one for explicit memory leaks. Before one can record anything the program to profile has to be chosen in the “Choose Target” drop-down menu. Click “Record” and wait for the program to terminate (after 10 seconds) and you’ll have the following results:</p>

<p><a href="/images/instruments-app-1.png"><img alt="Instruments.app showing memory leaks in memleak.cpp" src="/images/instruments-app-1.png" width="800" /></a></p>

<p>Clicking the “Leaks” instrument you will see:</p>

<p><a href="/images/instruments-app-2.png"><img alt="Instruments.app showing memory leaks in memleak.cpp" src="/images/instruments-app-2.png" width="800" /></a></p>

<p>Just to show the difference try inserting <code class="highlighter-rouge">delete[] test;</code> after line 5 in the code, recompile and re-record the analysis. You’ll see the following:</p>

<p><a href="/images/instruments-app-3.png"><img alt="Instruments.app showing no memory leaks in memleak.cpp" src="/images/instruments-app-3.png" width="800" /></a></p>

<p>Sometimes it’s necessary and insightful to gaze upon the call stacks:</p>

<p><a href="/images/instruments-app-4.png"><img alt="Instruments.app showing call stack in memleak.cpp" src="/images/instruments-app-4.png" width="800" /></a>Furthermore, any system libraries and missing symbols can be hidden in the “Call Tree” sidebar for convenience. If the program was compiled with debugging symbols (use <code class="highlighter-rouge">-g</code> with GCC or Clang, for instance) the source code along with the machine code can be shown by double-clicking an entry:</p>

<p><a href="/images/instruments-app-5.png"><img alt="Instruments.app showing machine code for memleak.cpp" src="/images/instruments-app-5.png" width="800" /></a></p>

<p>In any case, I will try using this profiler more at work and see if I find more interesting features to share.</p>


</div>

<div id="related">
  <h3>Related Posts</h3>
  <ul class="posts">
    
    <li>
      <span>29 Aug 2016 &raquo;</span> <a href="/2016/08/29/rewamped-for-github/">Rewamped for GitHub</a>
    </li>
    
    <li>
      <span>06 Mar 2013 &raquo;</span> <a href="/2013/03/06/proper-multithreading-with-qt/">Proper multithreading with Qt</a>
    </li>
    
    <li>
      <span>03 Mar 2013 &raquo;</span> <a href="/2013/03/03/unleashing-the-power-of-gdb-part2/">Unleashing the Power of GDB (part 2)</a>
    </li>
    
  </ul>
</div>


      <div class="footer">
        <div class="disclaimer">
  

  <p>
    © Morten Kristensen, 2016
  </p>
</div>

      </div>
    </div>
  </div>


</body>
</html>
